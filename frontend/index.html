<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Booking System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; }
        .seat { display: inline-block; width: 50px; height: 50px; margin: 5px; border: 1px solid #ccc; text-align: center; line-height: 50px; cursor: pointer; }
        .available { background-color: lightgreen; }
        .booked { background-color: lightcoral; }
        .selected { background-color: lightblue; }
    </style>
</head>
<body>
    <h1>Sleeper Bus Booking: Ahmedabad to Mumbai</h1>

    <div class="section">
        <h2>1. Select Route</h2>
        <label>From: <select id="from"></select></label>
        <label>To: <select id="to"></select></label>
        <button onclick="loadSeats()">View Seats</button>
    </div>

    <div class="section">
        <h2>2. View Seat Layout</h2>
        <div id="seats"></div>
    </div>

    <div class="section">
        <h2>3. Select Seat</h2>
        <p id="selectedSeat">No seat selected</p>
        <button onclick="predictConfirmation()">Predict Confirmation</button>
        <p id="prediction"></p>
    </div>

    <div class="section">
        <h2>4. Select Meal</h2>
        <label>Meal: <select id="meal">
            <option value="None">None</option>
            <option value="Veg">Veg</option>
            <option value="Non-Veg">Non-Veg</option>
        </select></label>
    </div>

    <div class="section">
        <h2>5. Confirm Booking</h2>
        <label>Passenger Name: <input type="text" id="passengerName"></label>
        <button onclick="confirmBooking()">Confirm Booking</button>
        <p id="bookingStatus"></p>
    </div>

    <div class="section">
        <h2>6. Booking Management</h2>
        <button onclick="loadHistory()">View Booking History</button>
        <div id="history"></div>
        <label>Booking ID to Cancel: <input type="number" id="cancelId"></label>
        <button onclick="cancelBooking()">Cancel Booking</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let selectedSeatId = null;
        let currentFrom, currentTo;

        // Load stations
        fetch(`${API_BASE}/stations`)
            .then(res => res.json())
            .then(data => {
                const fromSelect = document.getElementById('from');
                const toSelect = document.getElementById('to');
                data.forEach(station => {
                    fromSelect.innerHTML += `<option value="${station}">${station}</option>`;
                    toSelect.innerHTML += `<option value="${station}">${station}</option>`;
                });
                fromSelect.value = 'Ahmedabad';
                toSelect.value = 'Mumbai';
            });

        function loadSeats() {
            currentFrom = document.getElementById('from').value;
            currentTo = document.getElementById('to').value;
            fetch(`${API_BASE}/seats?from=${currentFrom}&to=${currentTo}`)
                .then(res => res.json())
                .then(data => {
                    const seatsDiv = document.getElementById('seats');
                    seatsDiv.innerHTML = '';
                    for (let i = 1; i <= 10; i++) {
                        const seat = data.find(s => s.id === i) || { id: i, status: 'booked' };
                        const className = seat.status === 'available' ? 'available' : 'booked';
                        seatsDiv.innerHTML += `<div class="seat ${className}" onclick="selectSeat(${i})">${i}</div>`;
                    }
                });
        }

        function selectSeat(id) {
            selectedSeatId = id;
            document.getElementById('selectedSeat').textContent = `Selected Seat: ${id}`;
        }

        function predictConfirmation() {
            if (!selectedSeatId) return alert('Select a seat first');
            fetch(`${API_BASE}/predict?seatId=${selectedSeatId}&from=${currentFrom}&to=${currentTo}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('prediction').textContent = `Confirmation Probability: ${data.probability}%`;
                });
        }

        function confirmBooking() {
            const passengerName = document.getElementById('passengerName').value;
            const meal = document.getElementById('meal').value;
            if (!passengerName || !selectedSeatId) return alert('Enter name and select seat');
            fetch(`${API_BASE}/book-seat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ passengerName, seatId: selectedSeatId, from: currentFrom, to: currentTo })
            })
            .then(res => res.json())
            .then(data => {
                if (data.bookingId) {
                    document.getElementById('bookingStatus').textContent = `Booking confirmed. ID: ${data.bookingId}`;
                    // Add meal
                    fetch(`${API_BASE}/book-meal`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bookingId: data.bookingId, meal })
                    });
                    loadSeats(); // Refresh
                } else {
                    document.getElementById('bookingStatus').textContent = data.error;
                }
            });
        }

        function loadHistory() {
            fetch(`${API_BASE}/booking-history`)
                .then(res => res.json())
                .then(data => {
                    const historyDiv = document.getElementById('history');
                    historyDiv.innerHTML = '<ul>' + data.map(b => `<li>ID: ${b.id}, Name: ${b.passengerName}, Seat: ${b.seatId}, From: ${b.from}, To: ${b.to}, Meal: ${b.meal}</li>`).join('') + '</ul>';
                });
        }

        function cancelBooking() {
            const id = document.getElementById('cancelId').value;
            fetch(`${API_BASE}/cancel-booking`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bookingId: parseInt(id) })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                loadSeats();
                loadHistory();
            });
        }
    </script>
</body>
</html>